#include <WiFi.h>
#include <WebServer.h>
#include <Arduino.h>
#include <ESP32Servo.h>
const char* ssid = "Andrew Nguyen";
const char* pass = "chienhd123";

WebServer server(80); // create a web server
Servo sg90;
// pinout for parking LEDs
int ledPins[6] = {16, 17, 18, 19, 21, 22};
String lastMessage = "No message yet";
String spotStatus[6] = {"unknown","unknown","unknown","unknown","unknown","unknown"};

// ================== PLATE LED + LIST ==================
const int servo_pinout = 23;   // LED bật khi biển số match

// List biển số (3 số) - sửa theo ý bạn
String allowedPlates[] = {"123", "942", "555", "001"};
const int ALLOWED_COUNT = sizeof(allowedPlates) / sizeof(allowedPlates[0]);

String lastPlate = "";         
bool lastPlateOk = false;       

// ✅ TIMEOUT: Turn off LED when no valid plate
unsigned long lastValidPlateTime = 0;
const unsigned long PLATE_TIMEOUT = 3000; // ms (500~1500 tuỳ camera/network)

bool plateAllowed(const String &n) {
  for (int i = 0; i < ALLOWED_COUNT; i++) {
    if (n == allowedPlates[i]) return true;
  }
  return false;
}

void handlePlate() {

  if (!server.hasArg("n")) {
    String html = "<h2>Plate Check</h2>";

    html += "<p><b>Last plate:</b> " + (lastPlate.length() ? lastPlate : String("(none)")) + "</p>";
    html += "<p><b>Plate match:</b> " + String(lastPlateOk ? "YES" : "NO") + "</p>";
    html += "<p><b>LED23:</b> " + String(lastPlateOk ? "ON" : "OFF") + "</p>";

    html += "<hr><p><b>Allowed plates:</b> ";
    for (int i = 0; i < ALLOWED_COUNT; i++) {
      html += allowedPlates[i];
      if (i < ALLOWED_COUNT - 1) html += ", ";
    }
    html += "</p>";

    html += "<p>Submit plate: <code>/plate?n=123</code></p>";

    server.send(200, "text/html", html);
    return;
  }

  // CASE 2: /plate?n=123 -> receive plate
  String n = server.arg("n");
  n.trim();  // remove space
  lastPlate = n;

  bool ok = plateAllowed(n);
  lastPlateOk = ok;

  if (ok) {
    
    sg90.write(90);
    delay(10);
    lastValidPlateTime = millis();
  } else {

      sg90.write(0);
      delay(10); 
    
  }

  Serial.print("Plate received: ");
  Serial.print(n);
  Serial.print(" -> ");
  Serial.println(ok ? "ALLOWED (LED23 ON)" : "DENIED (LED23 OFF)");

  server.send(200, "text/plain", ok ? "ALLOWED" : "DENIED");
}
// ======================================================

// send s=111111
void handleLed() {
  if (!server.hasArg("s")) {
    server.send(400, "text/plain", "Missing s");
    return;
  }

  String s = server.arg("s");

  if (s.length() != 6) {
    server.send(400, "text/plain", "Need 6 chars");
    return;
  }

  for (int i = 0; i < 6; i++) {
    if (s[i] == '1')
      digitalWrite(ledPins[i], HIGH);   // FREE -> LED ON
    else
      digitalWrite(ledPins[i], LOW);    // OCCUPIED -> LED OFF
  }

  server.send(200, "text/plain", "OK");
}

void handleMsg() {
  if (!(server.hasArg("spot") && server.hasArg("status"))) {
    server.send(400, "text/plain", "Missing spot and status");
    return;
  }

  int spot = server.arg("spot").toInt();   // 1..6
  String status = server.arg("status");
  status.toLowerCase();

  if (spot >= 1 && spot <= 6) {
    spotStatus[spot - 1] = status;
  }

  // Update lastMessage for handleRoot()
  String html = "";
  bool freeFlag = false;

  for (int i = 0; i < 6; i++) {
    if (spotStatus[i] == "free") {
      freeFlag = true;
      html += "Spot " + String(i + 1) + " is FREE<br>";
    }
  }

  if (!freeFlag) {
    html = "No free spots";
  }

  lastMessage = html;
  server.send(200, "text/plain", "OK");
}

void handleRoot() {
  server.send(200, "text/html",
              "<h2>Smart Parking</h2>"
              "<p>" + lastMessage + "</p>"
              "<hr><p>Plate page: <a href=\"/plate\">/plate</a></p>");
}

void setup() {
  Serial.begin(115200);

  for (int i = 0; i < 6; i++) {
    pinMode(ledPins[i], OUTPUT);
    digitalWrite(ledPins[i], LOW);
  }

  pinMode(servo_pinout, OUTPUT);
  digitalWrite(servo_pinout, LOW);
  sg90.setPeriodHertz(50);
  sg90.attach(servo_pinout,500,2400);
  WiFi.mode(WIFI_STA);
  WiFi.begin(ssid, pass);

  Serial.print("Connecting");
  while (WiFi.status() != WL_CONNECTED) {
    delay(300);
    Serial.print(".");
  }

  Serial.println();
  Serial.print("ESP32 IP: ");
  Serial.println(WiFi.localIP());

  server.on("/", handleRoot);
  server.on("/led", handleLed);
  server.on("/msg", handleMsg);
  server.on("/plate", handlePlate);

  server.begin();
}

void loop() {
  server.handleClient();

  
 
  
}
